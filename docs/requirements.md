# Discord コマンド機能 要件定義書

## はじめに

このドキュメントは、GitHub Issues Discord Threads Bot に Discord スラッシュコマンド機能を追加するための要件を定義します。この機能により、管理者は Discord 上から直接 GitHub リポジトリの監視を動的に管理できるようになり、設定ファイルの手動編集やボットの再起動が不要になります。

## 要件

### 要件 1: リポジトリ監視の開始

**ユーザーストーリー:** 管理者として、Discord コマンドを使用して新しい GitHub リポジトリの監視を開始したい。これにより、設定ファイルを手動で編集することなく、迅速に監視を設定できる。

#### 受け入れ基準

1. WHEN 管理者が `/watch` コマンドを実行 THEN システムは owner と repo パラメータを要求する
2. IF 指定されたリポジトリが GitHub に存在する THEN システムは監視を開始する
3. IF 指定されたリポジトリが既に監視中である THEN システムはエラーメッセージを表示する
4. WHEN 監視が開始される THEN システムは指定されたカテゴリ下にフォーラムチャンネルを自動作成する
5. WHEN フォーラムチャンネルが作成される THEN システムは config.json にマッピング情報を保存する
6. IF config.json に forum_category_id が設定されていない THEN システムはエラーメッセージを表示し処理を中断する
7. WHEN 監視が正常に開始される THEN システムは成功メッセージを Discord に表示する
8. WHEN 監視が開始される THEN システムは既存のすべての Issue を自動同期する

### 要件 2: リポジトリ監視の停止

**ユーザーストーリー:** 管理者として、不要になったリポジトリの監視を Discord コマンドで停止したい。これにより、リソースを効率的に管理できる。

#### 受け入れ基準

1. WHEN 管理者が `/unwatch` コマンドを実行 THEN システムは owner と repo パラメータを要求する
2. IF 指定されたリポジトリが監視中である THEN システムは監視を停止する
3. IF delete_channel オプションが true に設定されている THEN システムは関連するフォーラムチャンネルも削除する
4. WHEN 監視が停止される THEN システムは config.json からマッピング情報を削除する
5. IF 指定されたリポジトリが監視されていない THEN システムはエラーメッセージを表示する
6. WHEN 監視が正常に停止される THEN システムは成功メッセージを Discord に表示する

### 要件 3: 監視リポジトリの一覧表示

**ユーザーストーリー:** ユーザーとして、現在監視中のリポジトリの一覧を確認したい。これにより、どのリポジトリが監視されているか把握できる。

#### 受け入れ基準

1. WHEN ユーザーが `/list` コマンドを実行 THEN システムは現在監視中のすべてのリポジトリを表示する
2. WHEN リポジトリ一覧が表示される THEN システムは各リポジトリのオーナー、名前、関連チャンネル ID を含める
3. IF 監視中のリポジトリが存在しない THEN システムは「監視中のリポジトリはありません」というメッセージを表示する
4. WHEN 一覧が表示される THEN システムは Discord Embed 形式で見やすく整形する

### 要件 4: オープンアクセス

**ユーザーストーリー:** ユーザーとして、権限に関係なく自由にコマンドを実行したい。これにより、誰でも簡単にリポジトリ監視を管理できる。

#### 受け入れ基準

1. WHEN 任意のユーザーが `/watch` コマンドを実行する THEN システムは権限チェックなしで処理する
2. WHEN 任意のユーザーが `/unwatch` コマンドを実行する THEN システムは権限チェックなしで処理する
3. WHEN 任意のユーザーが `/list` コマンドを実行する THEN システムは監視中のリポジトリ一覧を表示する
4. WHEN Botがコマンドを実行する THEN システムは通常のユーザーと同様に処理する

### 要件 5: 動的設定管理

**ユーザーストーリー:** システムとして、実行時に設定を動的に更新し、再起動なしで変更を反映したい。これにより、サービスの可用性を維持できる。

#### 受け入れ基準

1. WHEN 新しいマッピングが追加される THEN システムは即座に監視を開始する
2. WHEN マッピングが削除される THEN システムは即座に監視を停止する
3. WHEN config.json が更新される THEN システムはファイルロック機構を使用して安全に書き込む
4. IF config.json の更新に失敗した場合 THEN システムは変更をロールバックし、エラーメッセージを表示する
5. WHEN ボットが再起動される THEN システムは config.json から設定を読み込み、すべての監視を復元する

### 要件 6: エラーハンドリングとフィードバック

**ユーザーストーリー:** ユーザーとして、操作の結果を明確に理解したい。これにより、問題が発生した場合に適切に対処できる。

#### 受け入れ基準

1. WHEN エラーが発生する THEN システムは具体的なエラーメッセージを Discord に表示する
2. WHEN GitHub API がレート制限に達する THEN システムは適切な待機時間を含むメッセージを表示する
3. WHEN Discord API がレート制限に達する THEN システムは操作を遅延させ、リトライする
4. WHEN 長時間の処理（初期同期など）が実行される THEN システムは進捗状況を定期的に更新する
5. IF チャンネル作成に失敗した場合 THEN システムはすべての変更をロールバックする

### 要件 7: データの整合性

**ユーザーストーリー:** システム管理者として、データの整合性を維持したい。これにより、システムの信頼性を確保できる。

#### 受け入れ基準

1. WHEN config.json を更新する前 THEN システムはバックアップファイルを作成する
2. IF 複数のコマンドが同時に実行される THEN システムは適切なロック機構で競合を防ぐ
3. WHEN マッピングが作成される THEN システムは一意の ID を生成し、重複を防ぐ
4. IF システムクラッシュが発生した場合 THEN config.json の整合性は保たれる
5. WHEN 初期同期が中断される THEN システムは次回起動時に同期を再開できる状態を維持する

### 要件 8: パフォーマンス

**ユーザーストーリー:** ユーザーとして、コマンドが迅速に応答することを期待する。これにより、効率的に作業を進められる。

#### 受け入れ基準

1. WHEN `/watch` コマンドが実行される THEN システムは 10 秒以内に監視を開始する
2. WHEN `/list` コマンドが実行される THEN システムは 3 秒以内に結果を表示する
3. IF 大量の Issue が存在する場合 THEN システムは非同期で同期を実行し、即座に応答を返す
4. WHEN 初期同期が実行される THEN システムはすべての Issue を同期する
5. IF API レート制限に近づいた場合 THEN システムは処理を適切に調整する

### 要件 9: コマンド実行場所

**ユーザーストーリー:** ユーザーとして、サーバー内の任意のチャンネルでコマンドを実行したい。これにより、状況に応じて最も便利な場所から操作できる。

#### 受け入れ基準

1. WHEN コマンドが任意のテキストチャンネルで実行される THEN システムはコマンドを処理する
2. WHEN コマンドがボイスチャンネルで実行される THEN システムはコマンドを無視する
3. WHEN コマンドがフォーラムチャンネル内で実行される THEN システムは正常に処理する
4. WHEN コマンドがスレッド内で実行される THEN システムは正常に処理する
5. IF ユーザーがそのチャンネルへの書き込み権限を持たない THEN Discord が自動的にコマンド実行を防ぐ

### 要件 10: 他のBotからのコマンド実行サポート

**ユーザーストーリー:** ユーザーとして、既存の別のBotやWebhookからもコマンドを実行したい。これにより、柔軟な運用が可能になる。

#### 受け入れ基準

1. WHEN プレフィックスコマンド（例: !watch）が送信される THEN システムはスラッシュコマンドと同様に処理する
2. WHEN 任意のBotが `!watch owner repo` を送信する THEN システムは `/watch` と同じ処理を実行する
3. WHEN 任意のユーザーまたはBotがプレフィックスコマンドを送信する THEN システムは送信者を区別せずに処理する
4. IF メンション形式（@Bot watch）が使用される THEN システムはコマンドとして処理する
5. WHEN Webhook経由でコマンドが送信される THEN システムは通常のメッセージと同様に処理する
6. IF コマンドの形式が正しくない THEN システムは使用方法を案内する

## 非機能要件

### セキュリティ
- すべての GitHub API トークンは環境変数で管理される
- Discord のコマンド実行ログは記録される
- 機密情報はログに出力されない

### 保守性
- コードは TypeScript で記述され、型安全性を確保する
- 各コンポーネントは単体テスト可能な設計とする
- エラーメッセージは詳細で、トラブルシューティングに役立つ情報を含む

### 拡張性
- 新しいコマンドを容易に追加できる構造とする
- 将来的な機能拡張（バッチ処理、カスタムフィルターなど）を考慮した設計とする

## 制約事項

- Discord API のレート制限に準拠する必要がある
- GitHub API のレート制限に準拠する必要がある
- フォーラムチャンネルのカテゴリは事前に作成されている必要がある
- 一つのカテゴリに作成できるチャンネル数には Discord の制限が適用される

## 設定例（config.json）

```json
{
  "forum_category_id": "1234567890123456789",
  "command_settings": {
    "enable_auto_sync": true,
    "prefix": "!"
  }
}
```

## 用語定義

- **マッピング**: GitHub リポジトリと Discord フォーラムチャンネルの関連付け
- **初期同期**: 新しく監視を開始した際に、既存の GitHub Issue を Discord に反映する処理
- **フォーラムチャンネル**: Discord の特殊なチャンネルタイプで、スレッド形式の議論に適している
- **admin_role_id**: Discord で管理者権限を持つロールの ID
- **forum_category_id**: フォーラムチャンネルを作成するカテゴリの ID